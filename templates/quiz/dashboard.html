{% extends 'quiz/base.html' %}
{% load static %}

{% block title %}Dashboard | SmartQuizArena{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--card-border);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }

    .stat-card {
        padding: 30px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #ffffff;
    }

    .stat-value {
        font-size: 3.5rem;
        font-weight: 800;
        margin: 10px 0;
        text-shadow: none;
    }

    .stat-label {
        text-transform: uppercase;
        letter-spacing: 2px;
        font-size: 0.9rem;
        color: var(--secondary-color);
        font-weight: 600;
    }

    .welcome-card {
        background: linear-gradient(135deg, #0d6efd 0%, #0099ff 100%);
        border: none;
    }

    .recent-item {
        transition: background 0.2s;
        border-left: 4px solid transparent;
        color: var(--text-color);
    }

    .recent-item:hover {
        background: rgba(13, 110, 253, 0.05);
        border-left-color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Welcome Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="dashboard-card welcome-card text-white shadow-lg">
                <div class="card-body p-5">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <h1 class="display-4 fw-bold mb-2">Welcome back, {{ user.username }}! üëã</h1>
                            <p class="fs-4 opacity-75 mb-0">Ready to challenge yourself today?</p>
                        </div>

                        <div class="d-flex gap-3">
                            <a href="{% url 'quiz:single_player' %}"
                                class="btn btn-light btn-lg px-4 fw-bold text-primary shadow-sm">
                                ‚ñ∂ Play Solo
                            </a>
                            <a href="{% url 'quiz:multiplayer' %}" class="btn btn-outline-light btn-lg px-4 fw-bold">
                                üë• Multiplayer
                            </a>
                            <a href="{% url 'quiz:coding_battle' %}"
                                class="btn btn-outline-warning btn-lg px-4 fw-bold">
                                ‚öîÔ∏è Coding Battle
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4 mb-5">
        <div class="col-md-3 col-sm-6">
            <div class="dashboard-card stat-card">
                <div class="stat-label">Total Score</div>
                <div class="stat-value text-warning">{{ user.total_score }}</div>
                <div class="small text-muted">Points Earned</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="dashboard-card stat-card">
                <div class="stat-label">Games Played</div>
                <div class="stat-value text-info">{{ stats.total_quizzes }}</div>
                <div class="small text-muted">Total Matches</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="dashboard-card stat-card">
                <div class="stat-label">Win Rate</div>
                <div class="stat-value text-success">{{ stats.win_rate }}%</div>
                <div class="small text-muted">Victory Ratio</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="dashboard-card stat-card">
                <div class="stat-label">Best Score</div>
                <div class="stat-value text-danger">{{ stats.best_score }}</div>
                <div class="small text-muted">Personal Best</div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Performance Chart -->
        <div class="col-lg-8">
            <div class="dashboard-card">
                <div class="card-header bg-transparent border-bottom border-secondary p-4">
                    <h4 class="mb-0 fw-bold">üìà Performance Trend</h4>
                </div>
                <div class="card-body p-4">
                    <canvas id="performanceChart" style="max-height: 400px; width: 100%;"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="col-lg-4">
            <div class="dashboard-card">
                <div class="card-header bg-transparent border-bottom border-secondary p-4">
                    <h4 class="mb-0 fw-bold">üïí Recent Activity</h4>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for quiz in recent_quizzes %}
                        <div class="list-group-item p-4 recent-item border-bottom">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0 fw-bold text-capitalize">
                                    {% if quiz.mode == 'single' %}üë§ Single Player
                                    {% elif quiz.mode == 'multiplayer' %}üë• Multiplayer
                                    {% else %}‚öîÔ∏è Coding Battle{% endif %}
                                </h5>
                                <span class="badge bg-light text-dark border">{{ quiz.date|date:"M d, H:i" }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="text-muted small">Score:</span>
                                    <span class="fw-bold text-primary">{{ quiz.score }}</span>
                                </div>
                                <div>
                                    <span class="text-muted small">Accuracy:</span>
                                    <span
                                        class="fw-bold {% if quiz.accuracy >= 70 %}text-success{% elif quiz.accuracy >= 40 %}text-warning{% else %}text-danger{% endif %}">
                                        {{ quiz.accuracy|floatformat:0 }}%
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="p-5 text-center text-muted">
                            <div class="fs-1 mb-3">üì≠</div>
                            <p class="mb-0">No recent quizzes found.</p>
                            <a href="{% url 'quiz:single_player' %}" class="btn btn-sm btn-primary mt-3">Start a
                                Quiz</a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const dates = JSON.parse('{{ trend_dates|safe }}');
    const scores = JSON.parse('{{ trend_scores|safe }}');

    // Gradient for the chart
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(13, 110, 253, 0.5)');
    gradient.addColorStop(1, 'rgba(13, 110, 253, 0.0)');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Score History',
                data: scores,
                borderColor: '#0d6efd',
                backgroundColor: gradient,
                borderWidth: 3,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#0d6efd',
                pointRadius: 6,
                pointHoverRadius: 8,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    titleColor: '#000',
                    bodyColor: '#000',
                    titleFont: { size: 14 },
                    bodyFont: { size: 14 },
                    padding: 10,
                    cornerRadius: 8,
                    displayColors: false,
                    borderColor: '#ddd',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        borderDash: [5, 5]
                    },
                    ticks: {
                        color: '#6c757d',
                        font: { size: 12 }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#6c757d',
                        font: { size: 12 }
                    }
                }
            }
        }
    });
</script>
{% endblock %}