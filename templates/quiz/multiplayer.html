{% extends 'quiz/base.html' %}

{% block title %}Multiplayer Arena | SmartQuizArena{% endblock %}

{% block extra_css %}
<style>
    .lobby-container {
        max-width: 1000px;
        margin: 0 auto;
    }

    .game-card {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 30px;
        height: 100%;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid var(--card-border);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .game-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }

    .timer-bar {
        height: 10px;
        background: #e9ecef;
        border-radius: 5px;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .timer-fill {
        height: 100%;
        background: #198754;
        width: 100%;
        transition: width 1s linear;
    }

    .option-btn {
        text-align: left;
        margin-bottom: 0.5rem;
        width: 100%;
        padding: 15px;
        border-radius: 10px;
        font-size: 1.1rem;
        transition: all 0.2s;
        background: #fff;
        color: var(--text-color);
        border: 1px solid var(--card-border);
    }

    .option-btn:hover {
        transform: translateX(5px);
        background: #f8f9fa;
        border-color: var(--primary-color);
    }

    .penalty-flash {
        animation: flashRed 0.5s;
    }

    @keyframes flashRed {
        0% {
            background-color: rgba(220, 53, 69, 0.2);
        }

        100% {
            background-color: transparent;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="display-5 fw-bold">🎮 Multiplayer Arena</h2>
        <a href="{% url 'quiz:dashboard' %}" class="btn btn-outline-primary">Back to Dashboard</a>
    </div>

    <!-- Connection Panel -->
    <div id="connectionPanel" class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <label class="form-label text-muted">Your Nickname</label>
            <input type="text" id="playerName" class="form-control" placeholder="Enter name">
        </div>
    </div>

    <!-- Lobby Controls -->
    <div id="lobbyControls" class="lobby-container">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="game-card">
                    <div class="card-header bg-transparent border-0 text-center">
                        <h3 class="text-primary">Create Room</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label text-muted">Select Topic</label>
                            <select class="form-select mb-3" id="topicSelect">
                                <option value="any">Any Topic</option>
                                <option value="python">Python</option>
                                <option value="web_development">Web Development</option>
                                <option value="algorithms">Algorithms</option>
                                <option value="science">Science</option>
                                <option value="history">History</option>
                                <option value="geography">Geography</option>
                            </select>

                            <label class="form-label text-muted">Difficulty</label>
                            <select id="difficultySelect" class="form-select mb-3">
                                <option value="any">Any Difficulty</option>
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>

                            <label class="form-label text-muted">Questions</label>
                            <input type="number" id="numQuestions" class="form-control" value="5" min="3" max="20">
                        </div>
                        <button id="createBtn" class="btn btn-primary w-100 py-2 fw-bold">Create Room</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="game-card">
                    <div class="card-header bg-transparent border-0 text-center">
                        <h3 class="text-success">Join Room</h3>
                    </div>
                    <div class="card-body d-flex flex-column justify-content-center">
                        <div class="mb-4">
                            <label class="form-label text-muted">Room Code</label>
                            <input type="text" id="roomInput" class="form-control form-control-lg"
                                placeholder="Enter Code">
                        </div>
                        <button id="joinBtn" class="btn btn-success w-100 py-2 fw-bold">Join Room</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Game UI -->
    <div id="activeGameUI" style="display:none;">
        <div class="card border-0 shadow-lg">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                <span id="roomNameDisplay" class="h5 mb-0">Room: -</span>
                <button id="copyRoomBtn" class="btn btn-sm btn-outline-primary">Copy Code</button>
            </div>
            <div class="card-body p-4">
                <div id="playersList" class="mb-4 d-flex gap-2 flex-wrap"></div>

                <!-- Game Area -->
                <div id="gameArea" style="display:none;">
                    <div class="timer-bar">
                        <div id="timerFill" class="timer-fill"></div>
                    </div>
                    <div id="timerText" class="text-center fw-bold mb-4 display-6 text-warning">15s</div>

                    <h3 id="qtext" class="mb-4 text-center">Question Text</h3>
                    <div id="qoptions" class="d-grid gap-2"></div>
                </div>

                <!-- Results -->
                <div id="results" style="display:none;">
                    <h3 class="text-center mb-4 display-5">Game Over!</h3>
                    <div id="resultsContent"></div>
                    <button onclick="location.reload()" class="btn btn-primary w-100 mt-4 btn-lg">Play Again</button>
                </div>
            </div>
            <div class="card-footer bg-white border-top text-center">
                <button id="leaveBtn" class="btn btn-sm btn-outline-danger">Leave Room</button>
            </div>
        </div>

        <div class="card mt-3 border-0 shadow-sm">
            <div class="card-body p-2">
                <small class="text-muted">Status Log:</small>
                <div id="status" class="small text-muted font-monospace" style="max-height: 100px; overflow-y: auto;">
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let socket = null;
    let room = null;
    let player = null;
    let timerInterval = null;

    function appendLog(msg) {
        const s = document.getElementById('status');
        const p = document.createElement('div');
        p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        s.prepend(p);
    }

    async function connectSocket(initialMsg) {
        const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
        const host = location.hostname + ':8000';
        const url = `${proto}://${host}/ws/quiz/`;

        return new Promise((resolve, reject) => {
            const s = new WebSocket(url);
            s.onopen = () => {
                socket = s;
                if (initialMsg) s.send(JSON.stringify(initialMsg));
                resolve(s);
            };
            s.onerror = (e) => reject(e);
            s.onclose = () => {
                document.getElementById('lobbyControls').style.display = 'block';
                document.getElementById('activeGameUI').style.display = 'none';
            };
            s.onmessage = (e) => handleMessage(JSON.parse(e.data));
        });
    }

    document.getElementById('createBtn').addEventListener('click', async () => {
        player = document.getElementById('playerName').value || 'Player' + Math.floor(Math.random() * 1000);
        try {
            await connectSocket({
                action: 'create',
                player: player,
                topic: document.getElementById('topicSelect').value,
                difficulty: document.getElementById('difficultySelect').value,
                num_questions: parseInt(document.getElementById('numQuestions').value)
            });
            showGameUI();
        } catch (e) { alert('Connection failed'); }
    });

    document.getElementById('joinBtn').addEventListener('click', async () => {
        player = document.getElementById('playerName').value || 'Player' + Math.floor(Math.random() * 1000);
        room = document.getElementById('roomInput').value;
        if (!room) return alert('Enter room code');
        try {
            await connectSocket({ action: 'join', player: player, room: room });
            showGameUI();
        } catch (e) { alert('Connection failed'); }
    });

    function showGameUI() {
        document.getElementById('lobbyControls').style.display = 'none';
        document.getElementById('activeGameUI').style.display = 'block';
    }

    document.getElementById('leaveBtn').addEventListener('click', () => {
        if (socket) socket.close();
        location.reload();
    });

    document.getElementById('copyRoomBtn').addEventListener('click', () => {
        navigator.clipboard.writeText(room);
        alert('Copied!');
    });

    function handleMessage(msg) {
        if (msg.event === 'created') {
            room = msg.room;
            document.getElementById('roomNameDisplay').textContent = 'Room: ' + room;
            updatePlayers(msg.players);
        } else if (msg.event === 'player_joined') {
            updatePlayers(msg.players);
        } else if (msg.event === 'question') {
            showQuestion(msg);
        } else if (msg.event === 'time_penalty') {
            applyPenalty(msg.player);
        } else if (msg.event === 'finished') {
            showResults(msg.results);
        } else if (msg.error) {
            alert(msg.error);
            location.reload();
        }
    }

    function updatePlayers(players) {
        document.getElementById('playersList').innerHTML = players.map(p =>
            `<span class="badge bg-primary fs-6">${p}</span>`
        ).join('');
    }

    function showQuestion(q) {
        document.getElementById('gameArea').style.display = 'block';
        document.getElementById('results').style.display = 'none';
        document.getElementById('qtext').textContent = `Q${q.order}/${q.total}: ${q.question_text}`;

        const opts = document.getElementById('qoptions');
        opts.innerHTML = '';
        q.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt;
            btn.onclick = () => submitAnswer(idx);
            opts.appendChild(btn);
        });
        startTimer(15);
    }

    function submitAnswer(idx) {
        const btns = document.querySelectorAll('.option-btn');
        btns.forEach(b => b.disabled = true);
        socket.send(JSON.stringify({
            action: 'answer',
            room: room,
            player: player,
            selected: idx
        }));
    }

    function startTimer(seconds) {
        clearInterval(timerInterval);
        let timeLeft = seconds;
        const fill = document.getElementById('timerFill');
        const text = document.getElementById('timerText');

        fill.className = 'timer-fill bg-success';
        fill.style.transition = 'none';
        fill.style.width = '100%';
        void fill.offsetWidth;
        fill.style.transition = `width ${seconds}s linear`;
        fill.style.width = '0%';

        text.textContent = timeLeft + 's';

        timerInterval = setInterval(() => {
            timeLeft--;
            text.textContent = timeLeft + 's';
            if (timeLeft <= 5) fill.className = 'timer-fill bg-danger';
            if (timeLeft <= 0) clearInterval(timerInterval);
        }, 1000);
    }

    function applyPenalty(pname) {
        if (pname === player) return;
        document.body.classList.add('penalty-flash');
        setTimeout(() => document.body.classList.remove('penalty-flash'), 500);
    }

    function showResults(results) {
        document.getElementById('gameArea').style.display = 'none';
        document.getElementById('results').style.display = 'block';

        const scores = results.scores || results;
        const sorted = Object.entries(scores).sort(([, a], [, b]) => b - a);

        let html = '<ul class="list-group">';
        sorted.forEach(([p, s], i) => {
            html += `<li class="list-group-item d-flex justify-content-between align-items-center p-3 ${i === 0 ? 'bg-success bg-opacity-10 border-success' : ''}">
                <span class="fs-5">${i === 0 ? '🏆 ' : ''}${p}</span>
                <span class="fw-bold fs-5 text-primary">${s} pts</span>
            </li>`;
        });
        html += '</ul>';
        document.getElementById('resultsContent').innerHTML = html;
    }
</script>
{% endblock %}