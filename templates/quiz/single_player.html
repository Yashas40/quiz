{% extends 'quiz/base.html' %}

{% block content %}
<div class="container py-5">
    <div class="quiz-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Single Player Quiz</h3>
            <div>
                <span class="me-2">Timer: <span id="timer">--</span>s</span>
                <button class="btn btn-outline-secondary" id="restartBtn">Restart</button>
            </div>
        </div>

        <div id="setupArea" class="mb-3">
            <div class="row g-2">
                <div class="col-md-6">
                    <label class="form-label">Topic</label>
                    <select id="topicSelect" class="form-select border-secondary">
                        <option value="">Any / Mixed</option>
                        <option value="Python">Python</option>
                        <option value="Web Development">Web Development</option>
                        <option value="Algorithms">Algorithms</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Questions</label>
                    <select id="numSelect" class="form-select border-secondary">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="15">15</option>
                        <option value="20">20</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button id="startBtn" class="btn btn-primary w-100">Start Quiz</button>
                </div>
            </div>
        </div>

        <div id="questionArea" style="display:none">
            <div class="question-card mb-3">
                <h5 id="questionText">Choose "Start Quiz" to begin</h5>
                <div id="optionsContainer" class="mt-3"></div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <div class="progress w-75 me-3" style="height:12px">
                    <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width:0%"></div>
                </div>
                <div>
                    <button id="nextBtn" class="btn btn-primary" style="display:none">Next</button>
                    <a href="{% url 'quiz:dashboard' %}" class="btn btn-secondary">Home</a>
                </div>
            </div>
        </div>

        <div id="resultArea" style="display:none" class="text-center mt-4"></div>
    </div>
</div>

<!-- CSRF token input so JS can read it -->
{% csrf_token %}

<style>
    .quiz-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .question-card {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--card-border);
    }

    .option-btn {
        text-align: left;
        padding: 15px 20px;
        margin-bottom: 15px;
        border-radius: 10px;
        border: 2px solid var(--card-border);
        background: #f8f9fa;
        color: var(--text-color);
        transition: all 0.2s ease;
        width: 100%;
        font-size: 1.1rem;
    }

    .option-btn:hover {
        background: #e9ecef;
        border-color: var(--primary-color);
        transform: translateX(5px);
    }

    .option-btn.selected {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .option-btn.correct {
        background: #198754 !important;
        border-color: #198754 !important;
        color: white;
    }

    .option-btn.incorrect {
        background: #dc3545 !important;
        border-color: #dc3545 !important;
        color: white;
    }
</style>

<script>
    let sessionId = null;
    let currentQuestion = null;
    let timer = 0;
    let timerInterval = null;
    let questionIndex = 0;
    let totalQuestions = 5;
    // Store user's answers locally until final reveal
    let userAnswers = [];

    function getCsrf() {
        const el = document.querySelector('[name=csrfmiddlewaretoken]');
        return el ? el.value : '';
    }

    function startTimer(seconds) {
        clearInterval(timerInterval);
        timer = seconds;
        document.getElementById('timer').textContent = timer;
        timerInterval = setInterval(() => {
            timer--;
            document.getElementById('timer').textContent = timer;
            if (timer <= 0) { clearInterval(timerInterval); submitAnswer(null); }
        }, 1000);
    }

    async function startSession() {
        const topic = document.getElementById('topicSelect').value;
        totalQuestions = parseInt(document.getElementById('numSelect').value, 10) || 5;

        const body = JSON.stringify({ topics: topic ? [topic] : [], num_questions: totalQuestions, time_per_question_seconds: 15 });
        const res = await fetch('{% url "quiz:start_single_session" %}', {
            method: 'POST', body, headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() }
        });
        const data = await res.json();
        if (data.session_id) {
            sessionId = data.session_id;
            questionIndex = 0;
            document.getElementById('setupArea').style.display = 'none';
            document.getElementById('questionArea').style.display = 'block';
            loadQuestion();
        } else if (data.error) {
            alert('Failed to start session: ' + data.error);
        }
    }

    async function loadQuestion() {
        if (!sessionId) return;
        try {
            const res = await fetch(`/get-next-question/${sessionId}/`);
            const data = await res.json();
            if (data.error) {
                // No more questions or server returned an error — show a friendly message
                document.getElementById('questionText').textContent = data.error || 'No more questions available';
                document.getElementById('optionsContainer').innerHTML = '';
                return;
            }

            currentQuestion = data;
            questionIndex++;
            renderQuestion(data);
            startTimer(data.time_limit || 15);
            updateProgress();
        } catch (err) {
            console.error(err);
            document.getElementById('questionText').textContent = 'Error loading question.';
        }
    }

    function renderQuestion(q) {
        document.getElementById('questionText').textContent = q.question_text;
        const oc = document.getElementById('optionsContainer');
        oc.innerHTML = '';
        (q.options || []).forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt;
            btn.onclick = () => selectOption(idx, btn);
            oc.appendChild(btn);
        });
        document.getElementById('nextBtn').style.display = 'none';
    }

    function selectOption(idx, btn) {
        // unselect others
        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        clearInterval(timerInterval);
        document.getElementById('nextBtn').style.display = 'inline-block';
    }

    async function submitAnswer(selectedIndex = null) {
        if (!currentQuestion || !sessionId) return;
        clearInterval(timerInterval);
        const fd = new FormData();
        fd.append('question_id', currentQuestion.question_id);
        if (selectedIndex !== null) { fd.append('answer', selectedIndex); }
        fd.append('session_id', sessionId);

        // store locally -- we will reveal correctness at the end
        userAnswers.push({ question_id: currentQuestion.question_id, selected: selectedIndex });

        try {
            const res = await fetch('{% url "quiz:submit_answer" %}', { method: 'POST', body: fd, headers: { 'X-CSRFToken': getCsrf() } });
            const data = await res.json();

            if (data.session_finished) {
                // reveal final summary with per-question details
                showFinalSummaryWithDetails(data.final_summary);
                return;
            }

            // proceed to next question without showing per-question feedback
            setTimeout(() => { loadQuestion(); }, 300);
        } catch (error) {
            console.error('Error submitting answer:', error);
        }
    }

    // Do not show per-question feedback. Collect answers and reveal at end.
    function showFeedback(isCorrect, correctIndex, explanation) {
        // placeholder kept for compatibility but intentionally does nothing
        return;
    }

    function showFinalSummaryWithDetails(summary) {
        // summary.per_question_summary contains array of questions with correct_index and explanation
        const per = summary.per_question_summary || [];
        // build map by question_id
        const map = {};
        per.forEach(p => { map[p.question_id] = p; });

        // compute list of incorrect answers with reasons
        const incorrectList = [];
        userAnswers.forEach(ans => {
            const q = map[ans.question_id];
            if (!q) return;
            const userSel = (ans.selected === null || ans.selected === undefined) ? null : Number(ans.selected);
            const correct = q.correct_index;
            if (correct === null || correct === undefined) return; // can't judge
            if (userSel !== correct) {
                incorrectList.push({
                    question_text: q.question_text,
                    your_answer: (q.options && userSel !== null && q.options[userSel]) ? q.options[userSel] : 'No answer',
                    correct_answer: (q.options && q.options[correct]) ? q.options[correct] : 'Unknown',
                    explanation: q.explanation || ''
                });
            }
        });

        // render final UI
        document.getElementById('questionArea').style.display = 'none';
        const ra = document.getElementById('resultArea');
        ra.style.display = 'block';
        let html = `
                <h3>Quiz Complete</h3>
                <p class="display-6">Score: ${summary.correct_answers}/${summary.total_questions}</p>
                <p>Incorrect: ${summary.incorrect_answers} • Accuracy: ${summary.accuracy.toFixed(1)}%</p>
            `;
        if (incorrectList.length > 0) {
            html += '<h5 class="mt-3">Review Incorrect Answers</h5>';
            incorrectList.forEach(it => {
                html += `<div class="card mb-2 border-secondary"><div class="card-body"><strong>${it.question_text}</strong><div class="mt-2">Your answer: <em>${it.your_answer}</em></div><div>Correct answer: <em>${it.correct_answer}</em></div><div class="mt-2">Explanation: ${it.explanation}</div></div></div>`;
            });
        }
        html += `<a class="btn btn-primary" href="/single-player/">Play again</a>`;
        ra.innerHTML = html;
    }

    function updateProgress() {
        const pct = Math.round((questionIndex / totalQuestions) * 100);
        document.getElementById('progressBar').style.width = pct + '%';
    }

    document.getElementById('startBtn').addEventListener('click', () => startSession());
    document.getElementById('nextBtn').addEventListener('click', () => {
        const sel = document.querySelector('.option-btn.selected');
        const idx = sel ? Array.from(sel.parentNode.children).indexOf(sel) : null;
        submitAnswer(idx);
    });
    document.getElementById('restartBtn').addEventListener('click', () => location.reload());
</script>
{% endblock %}